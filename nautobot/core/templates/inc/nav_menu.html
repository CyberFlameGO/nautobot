{% load static %}
{% load registry %}
{% load helpers %}
{% registry %}

<nav class="navbar navbar-expand-xxl navbar-light bg-light fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'home' %}">
            <img src="{% custom_branding_or_static 'logo' 'img/nautobot_logo.svg' %}" height="30" />
        </a>
        <button class="navbar-toggler collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbar" >
            {% if request.user.is_authenticated %}
                <ul class="navbar-nav">
                    {% for tab_name, tab_details in registry.nav_menu.tabs.items %}
                        {% if request.user|has_one_or_more_perms:tab_details.permissions or not "HIDE_RESTRICTED_UI"|settings_or_config %}
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-tab-weight="{{ tab_details.weight }}" data-bs-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                                    {{ tab_name }} <span class="caret"></span>
                                </a>
                                <ul class="dropdown-menu">
                                    {% for group_name, group_details in tab_details.groups.items %}
                                        {% if request.user|has_one_or_more_perms:group_details.permissions or not "HIDE_RESTRICTED_UI"|settings_or_config %}
                                            <li class="dropdown-header" data-group-weight="{{ group_details.weight }}">{{ group_name }}</li>
                                            {% for item_link, item_details in group_details.items.items %}
                                                {% if request.user|has_one_or_more_perms:item_details.permissions or not "HIDE_RESTRICTED_UI"|settings_or_config %}
                                                    <li {% if not request.user|has_perms:item_details.permissions %} class="disabled"{% endif %}>
                                                        <span class="float-end">
                                                                {% for button_title, button_details in item_details.buttons.items %}
                                                                    {% if request.user|has_perms:button_details.permissions %}
                                                                        {% comment %}
                                                                            Use 'url xxx as variable' so that an invalid
                                                                            link doesn't throw a NoReverseMatch exception.
                                                                        {% endcomment %}
                                                                        {% url button_details.link as button_url %}
                                                                        {% if button_url %}
                                                                            <a href="{{ button_url }}"
                                                                            data-button-weight="{{ button_details.weight }}"
                                                                            class="btn btn-sm btn-{{ button_details.button_class }}"
                                                                            title="{{ button_title }}">
                                                                                <i class="mdi {{ button_details.icon_class }}"></i>
                                                                            </a>
                                                                        {% else %}
                                                                            <a class="btn btn-sm btn-danger"
                                                                            title="ERROR: Invalid link!">
                                                                                <i class="mdi mdi-alert"></i>
                                                                            </a>
                                                                        {% endif %}
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </span>
                                                            <a class=dropdown-item href="{{ item_link }}"
                                                                data-item-weight="{{ item_details.weight }}">
                                                                {{ item_details.name }}
                                                            </a>
                                                    </li>
                                                {% endif %}
                                            {% endfor %}
                                            {% if not forloop.last %}
                                                <li><hr class="dropdown-divider"></li>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            {% endif %}

            {% if request.user.is_authenticated or not "HIDE_RESTRICTED_UI"|settings_or_config %}
                    <form action="{% url 'search' %}" method="get" class="navbar-form ms-auto" id="navbar_search" role="search">
                        <div class="input-group">
                            <input type="text" name="q" class="form-control" placeholder="Search {{ settings.BRANDING_TITLE }}">
                            <span class="input-group-btn">
                                <button type="submit" class="btn btn-primary">
                                    <i class="mdi mdi-magnify"></i>
                                </button>
                            </span>
                        </div>
                    </form>
                {% endif %}
            <ul class="nav navbar-nav ms-auto">
                {% if request.user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" title="{{ request.user }}" role="button" aria-haspopup="true" aria-expanded="false">
                            <i class="mdi mdi-account"></i>
                            <span id="navbar_user">{{ request.user|truncatechars:"30" }}</span>
                            <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{% url 'user:profile' %}"><i class="mdi mdi-account-box"></i> Profile</a></li>
                            {% if request.user.is_staff %}
                                <li><a class="dropdown-item" href="{% url 'admin:index' %}"><i class="mdi mdi-cogs"></i> Admin</a></li>
                            {% endif %}
                            <li class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="mdi mdi-logout"></i> Log out</a></li>
                        </ul>
                    </li>
                {% else %}
                    <li class="nav-item"><a class="dropdown-item" href="{% url settings.LOGIN_URL %}?next={{ request.get_full_path | urlencode }}"><i class="mdi mdi-login"></i> Log in</a></li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>
